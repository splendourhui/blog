<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Splendour's blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="Splendour&#39;s blog">
<meta property="og:url" content="http://splendourhui.com/index.html">
<meta property="og:site_name" content="Splendour&#39;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Splendour&#39;s blog">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'always',
    motion: true
  };
</script>

  <title> Splendour's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?12423411d7b24eae6e82e3173f32ab00";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Splendour's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">不积跬步，无以至千里</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      
        
        
        
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/13/使用 Rxjs 替代 Redux（二）/" itemprop="url">
                  使用 Rxjs 替代 Redux（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2017-08-13T14:50:55+08:00" content="2017-08-13">
              2017-08-13
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在前面，我们已经用 Rxjs 实现了 Store 和 Action。那么，对于前端开发领域非常重要的一块—-数据拉取，又如何用 Rxjs 来实现呢？</p>
<h3 id="异步-Action"><a href="#异步-Action" class="headerlink" title="异步 Action"></a>异步 Action</h3><p>在 Redux 中，我们把拉取数据的 Action 叫做异步 Action，主要实现方式有：</p>
<ul>
<li>直接 ajax 请求，在回调中执行其他的 Action</li>
<li>使用 <code>redux-thunk</code>，将异步 Action 分解为 Loading、Success、Failure 等状态，分别 dispatch 一个新的 Action</li>
<li>使用 <code>redux-saga</code>，将异步操作同步化</li>
<li>其他的库</li>
</ul>
<p>那么，我们在 Rxjs 中，也可以参考 Redux，实现我们的异步操作。</p>
<h4 id="异步请求也是一个流"><a href="#异步请求也是一个流" class="headerlink" title="异步请求也是一个流"></a>异步请求也是一个流</h4><p>Rxjs 提供了 <code>Observable.fromPromise</code> 方法，该方法可以将 Promise 函数转化为一个流，在 Promise resolve 数据的时候，emit 该数据，反之在 Promise reject 错误的时候，抛出该错误。<br>所以，我们将异步请求包装为一个 Promise 函数，并转化为一个流，这里使用了 fetch<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> needBody = <span class="function"><span class="keyword">method</span> =&gt;</span></div><div class="line">  <span class="title">method</span> === '<span class="title">POST</span>' || <span class="title">method</span> === '<span class="title">PATCH</span>' || <span class="title">method</span> === '<span class="title">PUT</span>';</div><div class="line"></div><div class="line"><span class="keyword">const</span> needQuery = <span class="function"><span class="keyword">method</span> =&gt; <span class="title">method</span> === '<span class="title">GET</span>';</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> fetchData = (<span class="function"><span class="keyword">method</span>, <span class="title">url</span>, <span class="title">data</span>?, <span class="title">options</span>?) =&gt; <span class="title">new</span> <span class="title">Promise</span><span class="params">((resolve, reject)</span> =&gt; <span class="comment">&#123;</span></span></div><div class="line">  let finalURL = url;</div><div class="line">  if (needQuery(method) &amp;&amp; data) &#123;</div><div class="line">    const params = Object.keys(data)</div><div class="line">      .filter(key =&gt; data[key] || data[key] === false)</div><div class="line">      .map(key =&gt; encodeURIComponent(key) + '=' + encodeURIComponent(data[key]))</div><div class="line">      .join('&amp;')</div><div class="line">      .replace(/%20/g, '+');</div><div class="line">    finalURL = `$&#123;url&#125;?$<span class="comment">&#123;params&#125;</span>`;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> finalOptions = Object.assign(<span class="comment">&#123;&#125;</span>, <span class="comment">&#123;</span></div><div class="line">    headers: &#123;</div><div class="line">      'Content-Type': 'application/json'</div><div class="line">    &#125;,</div><div class="line">    credentials: <span class="string">'same-origin'</span>,</div><div class="line">    <span class="function"><span class="keyword">method</span></span></div><div class="line">  &#125;, <span class="title">options</span>);</div><div class="line">  <span class="keyword">if</span> (needBody(<span class="function"><span class="keyword">method</span>)) <span class="comment">&#123;</span></span></div><div class="line">    finalOptions.body = JSON.stringify(data);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="title">fetch</span><span class="params">(finalURL, finalOptions)</span>.<span class="title">then</span><span class="params">(response =&gt; &#123;</span></div><div class="line">    <span class="keyword">if</span> (response.ok) <span class="comment">&#123;</span></div><div class="line">      response.json().then(res =&gt; resolve(res));</div><div class="line">    &#125; <span class="title">else</span> <span class="comment">&#123;</span></div><div class="line">      response.text().then(res =&gt; reject(res));</div><div class="line">    &#125;</div><div class="line">  &#125;).<span class="title">catch</span><span class="params">(err =&gt; &#123;</span></div><div class="line">    reject(err);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">export <span class="keyword">const</span> http = (<span class="function"><span class="keyword">method</span>, <span class="title">url</span>, <span class="title">data</span>?, <span class="title">options</span>?, <span class="title">errNotification</span>?) =&gt; <span class="comment">&#123;</span></span></div><div class="line">  return Observable.fromPromise&lt;any&gt;(fetchData(method, url, data, options, errNotification));</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="请求结果也是一个流"><a href="#请求结果也是一个流" class="headerlink" title="请求结果也是一个流"></a>请求结果也是一个流</h4><p>以上的 http 函数就是一个流，只要被订阅，就会执行异步操作，并且将请求结果或者失败原因用流的形式返回。<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">http(<span class="string">'GET'</span>, <span class="string">'/user'</span>, &#123;&#125;, &#123;&#125;).subscribe(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(data);</div><div class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这个流订阅一次之后只会执行一次，也符合我们对异步 Action 的需求。<br>然而，当多次发起请求（多次订阅）后会发现，我们之前的订阅没有被释放，造成了资源的浪费。所以我们定义自己的 request 函数如下：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">const request = (&#123;</div><div class="line">  method, url, data, options</div><div class="line">&#125;) =&gt; &#123;</div><div class="line">  const <span class="function"><span class="keyword">sub</span> = <span class="title">http</span>(<span class="title">method</span>, <span class="title">url</span>, <span class="title">data</span>, <span class="title">options</span>).<span class="title">subscribe</span>(<span class="title">data</span> =&gt; </span>&#123;</div><div class="line">    console.log(data);</div><div class="line">    <span class="function"><span class="keyword">sub</span>.<span class="title">unsubscribe</span></span>();</div><div class="line">  &#125;, <span class="string">err =&gt;</span> &#123;</div><div class="line">    console.log(err);</div><div class="line">    <span class="function"><span class="keyword">sub</span>.<span class="title">unsubscribe</span></span>();</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="自定义成功和失败回调"><a href="#自定义成功和失败回调" class="headerlink" title="自定义成功和失败回调"></a>自定义成功和失败回调</h4><p>我们需要在请求成功和失败之后，执行一些业务，这个时候就需要成功和失败的回调了。话不多说，直接上代码<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">const request = (&#123;</div><div class="line">  method, url, data, options, sucCallback, errCallback</div><div class="line">&#125;) =&gt; &#123;</div><div class="line">  const <span class="function"><span class="keyword">sub</span> = <span class="title">http</span>(<span class="title">method</span>, <span class="title">url</span>, <span class="title">data</span>, <span class="title">options</span>).<span class="title">subscribe</span>(<span class="title">data</span> =&gt; </span>&#123;</div><div class="line">    sucCallback(data);</div><div class="line">    <span class="function"><span class="keyword">sub</span>.<span class="title">unsubscribe</span></span>();</div><div class="line">  &#125;, <span class="string">err =&gt;</span> &#123;</div><div class="line">    errCallback(err);</div><div class="line">    <span class="function"><span class="keyword">sub</span>.<span class="title">unsubscribe</span></span>(); </div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这就是我们最终的请求函数。</p>
<h4 id="异步-Action-的最终形态"><a href="#异步-Action-的最终形态" class="headerlink" title="异步 Action 的最终形态"></a>异步 Action 的最终形态</h4><p>有了以上的请求函数，实现我们的异步 Action 就很方便了。比如一个拉取用户列表的 action，实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> loadUserList = <span class="function"><span class="params">params</span> =&gt;</span> &#123;</div><div class="line">  <span class="comment">// loading</span></div><div class="line">  userListLoading$.next(<span class="literal">true</span>);</div><div class="line">  </div><div class="line">  request(&#123;</div><div class="line">    <span class="attr">method</span>: <span class="string">'GET'</span>,</div><div class="line">    <span class="attr">url</span>: <span class="string">'/user'</span>,</div><div class="line">    <span class="attr">data</span>: params,</div><div class="line">    <span class="attr">sucCallback</span>: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">      <span class="comment">// 获取到数据，让 store 执行 next</span></div><div class="line">      userList$.next(data);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">errCallback</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">      <span class="comment">// 错误处理</span></div><div class="line">      showErrorToast(err);</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这样，我们就实现了在 React 中，调用 loadUserList 函数即可获取数据并改变 Store 中的值，UI 层只需要关注渲染，数据层隔离开来单独实现逻辑。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在本文我们实现了异步 Action，加上上文的 Store，普通的 Action，基本上可以实现所有的数据层面的操作了。还在等什么，赶紧用上 Rxjs，体验其独特的魔力。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/29/使用 Rxjs 替代 Redux（一）/" itemprop="url">
                  使用 Rxjs 替代 Redux（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2017-04-29T14:50:55+08:00" content="2017-04-29">
              2017-04-29
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在 Rxjs 中，一切都是流，我们订阅它们，并在它们改变的时候接收到最新的值。在 React 中，我们往组件传入参数，或者维护组件自身的状态，只要其中之一发生变化，组件就会重新渲染，达到页面更新的目的。结合一下，我们发现可以让组件订阅 Rxjs 的流，并且在流更新的时候刷新界面，这不就是单项数据流吗？</p>
<p>在 React 的使用过程中，我们通常使用 Redux 来管理一个全局的 Store，存储全局状态或数据，那我们是否可以用 Rxjs 来实现 Redux 的功能呢？</p>
<h3 id="替换-Store"><a href="#替换-Store" class="headerlink" title="替换 Store"></a>替换 Store</h3><p>Redux 的 Store 首先是用来存储数据的（可通过<a href="http://note.youdao.com/" target="_blank" rel="external">官方文档</a>详细了解）。结合之前的学习笔记，我们挑选了 BehaviorSubject 这个类来作为存储的数据流，因为它能实现数据共享，这也是 Store 中的数据能实现的。</p>
<h4 id="定义与订阅"><a href="#定义与订阅" class="headerlink" title="定义与订阅"></a>定义与订阅</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> loading$ = <span class="keyword">new</span> BehaviorSubject(<span class="literal">false</span>);</div></pre></td></tr></table></figure>
<p>在这里我们定义了一个 loading$，存储加载状态的显示和隐藏。在项目中，变量后面加个 $ 表示这是属于一个流。</p>
<p>在 React 组件中，我们订阅它，并将它的状态写入到 state，这样，就可以在每次更新的时候修改组件的 state，从而实现组件更新。</p>
<p>一般，我们在 componentDidMount 中实现数据订阅。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.subscriber = loading$.subscribe(<span class="function"><span class="params">loading</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">this</span>.setState(&#123;</div><div class="line">    <span class="attr">show</span>: loading</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>细心的同学会发现，订阅了之后，如果没有销毁，则该订阅会一直存在，数据源的变化会让这个订阅函数执行。这个时候如果组件已经不存在了，则会抛出异常（在一个不存在的组件中调用 setState 方法）。所以，我们需要在 componentWillUnmount 函数中，销毁该订阅。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">this</span><span class="selector-class">.subscriber</span><span class="selector-class">.unsubscribe</span>();</div></pre></td></tr></table></figure></p>
<h4 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h4><p>使用 Redux 的时候，我们可以方便地通过 createLogger 中间件来实现 Store 的实时打印，方面开发过程中对数据的监控和调试。那么，如果我们使用了 Rxjs，该如何进行数据流实时状态的打印呢？其实思路很清晰，就是需要在数据流发生状态改变的时候，添加打印的逻辑即可。</p>
<h5 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h5><p>Observable 提供了一个 do 方法</p>
<blockquote>
<p>Intercepts each emission on the source and runs a function, but returns an output which is identical to the source</p>
</blockquote>
<p>即提供了一个钩子，可以在 next、err 和 complete 三种状态发生时执行额外的操作，最终返回该 Observable 本身。所以，我们可以在 do 方法中，加入打印逻辑。<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Observable.prototype.debug = function (name) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.<span class="keyword">do</span>(</div><div class="line">    <span class="function"><span class="params">(next)</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (debuggerOn) &#123;</div><div class="line">        <span class="built_in">console</span>.log(`<span class="javascript">%c $&#123;name&#125; emit value: </span>`, `<span class="javascript">color: #<span class="number">4</span>CAF50; font-weight: bold</span>`, next);</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="params">(err)</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (debuggerOn) &#123;</div><div class="line">        <span class="built_in">console</span>.error(`<span class="javascript">$&#123;name&#125; <span class="keyword">throw</span> ERROR &gt;&gt;&gt; </span>`, err);</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (debuggerOn) &#123;</div><div class="line">        <span class="built_in">console</span>.log(`<span class="javascript">$&#123;name&#125; completed.</span>`);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  );</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>即拓展了 Observable，让它能链式调用 debug 方法，传入名称，实现打印。<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> loading$ = Observable.<span class="keyword">of</span>(<span class="literal">false</span>).debug(<span class="string">'[common]:[loading]'</span>);</div></pre></td></tr></table></figure></p>
<h5 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h5><p>如果是 BehaviorSubject 呢？我们尝试一下可以发现，如果将 BehaviorSubject 也调用 debug 方法，则会产生类型的转换，变成了普通的 Observable，使用 BehaviorSubject 的优势没了。查阅文档也没发现 BehaviorSubject 有类似 do 的方法，那么我们需要换个思路，自己实现类似的方法。</p>
<p>既然我们是需要在数据变化的时候打印，那么我们相当于要订阅这份数据，在不同状态下实现打印逻辑即可。从 do 函数的实现思路出发，我们可以订阅 BehaviorSubject 自身，实现打印逻辑后，返回本身，实现链式调用，所以我们可以拓展这样的一个 debug 方法。<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">BehaviorSubject.prototype.debug = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.subscribe(<span class="function">(<span class="params">next</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (debuggerOn) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">`%c <span class="subst">$&#123;name&#125;</span> emit value: `</span>, <span class="string">`color: #4CAF50; font-weight: bold`</span>, next);</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (debuggerOn) &#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">`<span class="subst">$&#123;name&#125;</span> throw ERROR &gt;&gt;&gt; `</span>, err);</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (debuggerOn) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;name&#125;</span> completed.`</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>使用也非常简单<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> loading$ = <span class="keyword">new</span> BehaviorSubject(<span class="keyword">false</span>).debug(<span class="string">'[common]:[loading]'</span>);</div></pre></td></tr></table></figure></p>
<h3 id="实现-Action"><a href="#实现-Action" class="headerlink" title="实现 Action"></a>实现 Action</h3><p>我们上面仅仅是实现了数据的至上而下传递。在 Redux 中，由用户操作等逻辑，组件本身需要修改 Store，是通过发送一个 Action 实现的；对于 Rxjs 来说，Store 层也需要提供相应的 Action，让组件可以调用，使得对应的数据流能 emit 新的数据，组件订阅的数据更新，从而实现组件的刷新。</p>
<p>这里使用很简便的方式来实现<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> showLoading = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  loading$.next(<span class="literal">true</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> hideLoading = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  loading$.next(<span class="literal">false</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>组件内部，在需要的地方，调用即可。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过以上的方式，我们可以很方便地使用 Rxjs 来替代 Redux，实现前端的数据层和数据传递。这些都是属于同步操作，那么，如何用 Rxjs 实现异步操作呢？下一篇文章将会继续分享。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/19/Rx-学习笔记（2）/" itemprop="url">
                  Rx 学习笔记（2）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2017-04-19T14:50:55+08:00" content="2017-04-19">
              2017-04-19
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在前文，我们通过 Observable 的相关方法创建了 Observable，并且用 subscribe 方法实现了订阅。然而我们发现，每次 subscribe ，都会执行 create 方法，产生一个新的 observer，只有当该 observer 调用 next 方法 emit 了一个值之后，该 subscriber 才会触发接收到事件。也即不同的 subscriber 是不能共享 observer 的值的。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> observer$$;</div><div class="line"><span class="keyword">var</span> customStream = Rx.Observable.create(<span class="function"><span class="keyword">function</span>(<span class="params">observer</span>) </span>&#123;</div><div class="line">  observer$$ = observer;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">var</span> sub1 = customStream.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'1 '</span>, value);</div><div class="line">&#125;);</div><div class="line">observer$$.next(<span class="number">1</span>);</div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> sub2 = customStream.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'2 '</span>, value);</div><div class="line">  &#125;);</div><div class="line">  observer$$.next(<span class="number">2</span>);</div><div class="line">&#125;, <span class="number">1000</span>);</div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  observer$$.next(<span class="number">3</span>);</div><div class="line">&#125;, <span class="number">2000</span>);</div><div class="line"></div><div class="line"><span class="comment">// console</span></div><div class="line"><span class="number">1</span> <span class="number">1</span></div><div class="line"><span class="number">2</span> <span class="number">2</span></div><div class="line"><span class="number">2</span> <span class="number">3</span></div></pre></td></tr></table></figure></p>
<p>当 customerStream 被 subscribe 多次之后，每一个被订阅的 observer 都拥有单独的一份数据，在某些场景下是很有意义的。然而，在一个 SPA 应用中，有时候我们需要实现数据的共享，即利用 store 存储数据供不同的组件同时使用，此时就需要使用另一个很有用的类——Subject</p>
<h3 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h3><blockquote>
<p>A Subject is like an Observable, but can multicast to many Observers. Subjects are like EventEmitters: they maintain a registry of many listeners.</p>
</blockquote>
<p>从文档的描述很容易理解，Subject 相对于 Observable 来说，提供了广播数据的功能，相当于共用一份 observer，接收来自多方的订阅。</p>
<ul>
<li>Every Subject is an Observable. 每一个 subject 都可以被订阅并提供一个 observer，只不过这个 observer 不会拥有一份单独的数据，而是被加入到了一个 observer 列表里面去，共同享有同一份数据。</li>
<li>Every Subject is an Observer. 每一个 sbuject 都有 next、error、complete 方法，调用后将会广播数据到每一个 observer<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> subject = <span class="keyword">new</span> Rx.Subject();</div><div class="line"><span class="keyword">var</span> sub1 = subject.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'1 '</span>, value);</div><div class="line">&#125;);</div><div class="line"><span class="keyword">var</span> sub2 = subject.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'2 '</span>, value);</div><div class="line">&#125;);</div><div class="line">subject.next(<span class="number">1</span>);</div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  subject.next(<span class="number">2</span>);</div><div class="line">&#125;, <span class="number">1000</span>);</div><div class="line"></div><div class="line"><span class="comment">// console</span></div><div class="line"><span class="number">1</span> <span class="number">1</span></div><div class="line"><span class="number">2</span> <span class="number">1</span></div><div class="line"><span class="number">1</span> <span class="number">2</span></div><div class="line"><span class="number">2</span> <span class="number">2</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="几种类型的-Subject"><a href="#几种类型的-Subject" class="headerlink" title="几种类型的 Subject"></a>几种类型的 Subject</h3><h4 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h4><ul>
<li>BehaviorSubject 是一种特殊的 Subject，会存储它 emit 的最后一个值，并且在有新的 subscriber 时，能够获取到这个值</li>
<li>我们可以在构造函数中给它设置初始值</li>
<li>BehaviorSubject 通常用来作为页面中的 store，存储可共享的数据</li>
</ul>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">var subject = new Rx.BehaviorSubject(<span class="number">0</span>);</div><div class="line">var sub1 = subject.subscribe(function(value) &#123;</div><div class="line">  console.log('<span class="number">1</span> ', value);</div><div class="line">&#125;);</div><div class="line">subject.next(<span class="number">1</span>);</div><div class="line">subject.next(<span class="number">2</span>);</div><div class="line">console.log(subject.getValue());</div><div class="line">var sub2 = subject.subscribe(function(value) &#123;</div><div class="line">  console.log('<span class="number">2</span> ', value);</div><div class="line">&#125;);</div><div class="line">subject.next(<span class="number">3</span>);</div><div class="line"></div><div class="line"><span class="comment">// console</span></div><div class="line"><span class="number">1</span> <span class="number">0</span></div><div class="line"><span class="number">1</span> <span class="number">1</span></div><div class="line"><span class="number">1</span> <span class="number">2</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">2</span> <span class="number">2</span></div><div class="line"><span class="number">1</span> <span class="number">3</span></div><div class="line"><span class="number">2</span> <span class="number">3</span></div></pre></td></tr></table></figure>
<p>可以看到，我们给 subject 设置了初始值，在 sub1 subscribe 时，获取到了初始值；在 sub2 subscribe 时，马上获得之前的最后一个值；之后 subject emit 值的时候，sub1 sub2 均能获取到该值。另外，BehaviorSubject 提供了 getValue 方法，可以方便地获取到当前的值，非常实用。</p>
<h4 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h4><ul>
<li>ReplySubject 和 Behavior 有点类似，也具有存储功能</li>
<li>ReplySubject 可以存储指定个数的最新数据</li>
<li>当 ReplySubject 有了新的 subscriber，可以获取到 replay 的几个值</li>
</ul>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">var subject = new Rx.ReplaySubject(<span class="number">3</span>);</div><div class="line">var sub1 = subject.subscribe(function(value) &#123;</div><div class="line">  console.log('<span class="number">1</span> ', value);</div><div class="line">&#125;);</div><div class="line">subject.next(<span class="number">1</span>);</div><div class="line">subject.next(<span class="number">2</span>);</div><div class="line">subject.next(<span class="number">3</span>);</div><div class="line">subject.next(<span class="number">4</span>);</div><div class="line">var sub2 = subject.subscribe(function(value) &#123;</div><div class="line">  console.log('<span class="number">2</span> ', value);</div><div class="line">&#125;);</div><div class="line">subject.next(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">// console</span></div><div class="line"><span class="number">1</span> <span class="number">1</span></div><div class="line"><span class="number">1</span> <span class="number">2</span></div><div class="line"><span class="number">1</span> <span class="number">3</span></div><div class="line"><span class="number">1</span> <span class="number">4</span></div><div class="line"><span class="number">2</span> <span class="number">2</span></div><div class="line"><span class="number">2</span> <span class="number">3</span></div><div class="line"><span class="number">2</span> <span class="number">4</span></div><div class="line"><span class="number">1</span> <span class="number">5</span></div><div class="line"><span class="number">2</span> <span class="number">5</span></div></pre></td></tr></table></figure>
<p>可以看到，我们给 subject 设置了 replay 次数 为3，则在执行了 4 次 next 之后，存储了最新的三次，并且在 sub2 subscirbe 时，获取到了这三个数据。往后的 emit 按照 subject 的规则继续进行下去。<br>另外，ReplaySubject 也接受第二个参数，是一个时间间隔，表示会存储最近的 N 毫秒之内的值，当然最大 replay 次数也是由第一个参数决定的。</p>
<h4 id="AsyncSubject"><a href="#AsyncSubject" class="headerlink" title="AsyncSubject"></a>AsyncSubject</h4><ul>
<li>AsyncSubject 只会将最后一个值给到 subscriber</li>
<li>AsyncSubject 只有在收到 complete 之后才会将值给出</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> subject = <span class="keyword">new</span> Rx.AsyncSubject();</div><div class="line"><span class="keyword">var</span> sub1 = subject.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'1 '</span>, value);</div><div class="line">&#125;);</div><div class="line">subject.next(<span class="number">1</span>);</div><div class="line">subject.next(<span class="number">2</span>);</div><div class="line">subject.next(<span class="number">3</span>);</div><div class="line">subject.next(<span class="number">4</span>);</div><div class="line"><span class="keyword">var</span> sub2 = subject.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'2 '</span>, value);</div><div class="line">&#125;);</div><div class="line">subject.next(<span class="number">5</span>);</div><div class="line">subject.complete();</div><div class="line"></div><div class="line"><span class="comment">// console</span></div><div class="line"><span class="number">1</span> <span class="number">5</span></div><div class="line"><span class="number">2</span> <span class="number">5</span></div></pre></td></tr></table></figure>
<p>AsyncSubject 有点像 Observable 的 last 方法，但区别是只会在收到 complete 之后才会将最终值给到</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Subject 是 Rxjs 中非常重要，而且也是非常常用的一种类型。在构建 Web 应用时，我们通常会隔离出 data 层和 view 层，那么 data 层的数据是很有可能被 view 层复用的，这个时候就需要 subject 来作为数据流，不同的 view subscribe 这个流来共享数据。另外，BehaviorSubject 这个类，可以用来作为 store，存储数据，并且随时获取到最新的值，非常实用。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/20/Rx-学习笔记（1）/" itemprop="url">
                  Rx 学习笔记（1）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2017-03-20T22:43:40+08:00" content="2017-03-20">
              2017-03-20
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="Reactive-Programming"><a href="#Reactive-Programming" class="headerlink" title="Reactive Programming"></a>Reactive Programming</h3><blockquote>
<p>Reactive Programming 其实就是处理异步数据流</p>
</blockquote>
<ul>
<li>在 Reactive 的世界里，所有的东西都可以当做一个 stream，比如变量，用户的输入，属性，缓存，数据结构等等</li>
</ul>
<blockquote>
<p>A stream is a sequence of ongoing events ordered in time</p>
</blockquote>
<ul>
<li><p>stream 是一序列按时间排序的正在发生的事件，各个事件会在发生时 emit 出来，比如一个 ajax 请求，在返回时会 emit 一个 value 或者 error</p>
</li>
<li><p>我们可以使用观察者模式，采用监听的方法捕获已经 emit 的事件，通过回调函数的方法来执行响应</p>
</li>
</ul>
<blockquote>
<p>监听 stream 也就是所谓的 subscribing ；回调函数就是所谓的 observers ；而 stream 也就是所谓的 subject (observable)</p>
</blockquote>
<h3 id="初探-Rxjs"><a href="#初探-Rxjs" class="headerlink" title="初探 Rxjs"></a>初探 Rxjs</h3><p>从 npm 上下载的 rxjs 版本是 5.2.0，以下代码均基于此版本</p>
<h4 id="简单变量"><a href="#简单变量" class="headerlink" title="简单变量"></a>简单变量</h4><p><code>Rx.Observable.of</code> 方法接收一个简单变量，构建一个 stream，emit 一个值，我们需要订阅它，回调函数就是它 emit 的那个值，从而进行其他操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Rx = <span class="built_in">require</span>(<span class="string">'rxjs/Rx'</span>);</div><div class="line"><span class="keyword">var</span> singleValue = Rx.Observable.of(<span class="string">'I am single value'</span>);</div><div class="line"><span class="built_in">console</span>.log(singleValue);</div><div class="line"><span class="comment">// ScalarObservable &#123; _isScalar: true, value: 'I am single value', scheduler: null &#125;</span></div><div class="line"></div><div class="line">singleValue.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(value);</div><div class="line">  <span class="comment">// I am single value</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>看上去好像比原来直接定义一个值复杂了，但这也是 rx 的思路，将所有东西都变成一个 stream，提供很多有趣的便捷的操作函数，我们继续往下一探究竟</p>
<h4 id="自定义-stream"><a href="#自定义-stream" class="headerlink" title="自定义 stream"></a>自定义 stream</h4><p><code>Rx.Observable.create</code> 方法接收一个参数，该参数为一个接收一个 Observer（观察者） 对象的方法，该方法中，可以用 next 来实现 emit，用 error 抛出错误，用 complete 结束 stream<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> customStream = Rx.Observable.create(<span class="function"><span class="keyword">function</span>(<span class="params">observer</span>) </span>&#123;</div><div class="line">  observer.next(<span class="string">'I am a custom stream'</span>);</div><div class="line">  observer.complete();</div><div class="line">&#125;);</div><div class="line">customStream.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(value);</div><div class="line">  <span class="comment">// I am a custom stream</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(err);</div><div class="line">  <span class="comment">// nothing</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Complete'</span>);</div><div class="line">  <span class="comment">// Complete</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>如果我们在中间抛出了错误<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> customStream = Rx.Observable.create(<span class="function"><span class="keyword">function</span>(<span class="params">observable</span>) </span>&#123;</div><div class="line">  observable.next(<span class="string">'I am a custom stream'</span>);</div><div class="line">  observable.error(<span class="string">'I am an error'</span>);</div><div class="line">  observable.complete();</div><div class="line">&#125;);</div><div class="line">customStream.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(value);</div><div class="line">  <span class="comment">// I am a custom stream</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(err);</div><div class="line">  <span class="comment">// I am an error</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Complete'</span>);</div><div class="line">  <span class="comment">// nothing</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>可以总结：只要有 next 就会 emit value，只要有 error 就会抛出错误，并且中断该 stream；只要没有 error，则会继续执行直到遇到 complete</p>
<h4 id="Promise-转化为-stream"><a href="#Promise-转化为-stream" class="headerlink" title="Promise 转化为 stream"></a>Promise 转化为 stream</h4><p>我们先定义一个简单的 Promise<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> simplePromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    resolve(<span class="string">'I am simple promise'</span>);</div><div class="line">  &#125;, <span class="number">1000</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p><code>Rx.Observable.fromPromise</code> 方法接收一个 Promise，转化为 stream，resolve 相当于 emit，reject 相当于 error，resolve 之后自动执行 complete<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">streamFromPromise.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(value);</div><div class="line">  <span class="comment">// I am simple promise</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(err);</div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Complete'</span>);</div><div class="line">  <span class="comment">// Complete</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><p>stream 提供了 <code>map</code> 方法，能将每一个 emit 的值进行转换<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> singleValue = Rx.Observable.of(<span class="string">'I am single value'</span>);</div><div class="line">singleValue</div><div class="line">  .map(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> value + <span class="string">' and map'</span>;</div><div class="line">  &#125;)</div><div class="line">  .subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(value);</div><div class="line">    <span class="comment">// I am single value and map</span></div><div class="line">  &#125;);</div></pre></td></tr></table></figure></p>
<p>stream 的流式操作和转换函数有很多，而且可以链式调用，特别方便。如果是需要根据 value 创建一个新的 stream，而我们只想要在 subscribe 时获取到新的 stream emit 的值，则可以用 <code>flatMap</code> 方法<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span></span> promiseWithParams(<span class="keyword">value</span>) &#123;</div><div class="line">  <span class="keyword">return</span> new Promise(<span class="function"><span class="keyword">function</span><span class="params">(resolve, reject)</span></span> &#123;</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> &#123;</div><div class="line">      resolve(<span class="keyword">value</span>);</div><div class="line">    &#125;, <span class="number">2000</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">singleValue</div><div class="line">  .flatMap(<span class="function"><span class="keyword">function</span><span class="params">(value)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> Rx.Observable.fromPromise(promiseWithParams(<span class="keyword">value</span>));</div><div class="line">  &#125;)</div><div class="line">  .subscribe(<span class="function"><span class="keyword">function</span><span class="params">(value)</span></span> &#123;</div><div class="line">    console.<span class="built_in">log</span>(<span class="keyword">value</span>);</div><div class="line">    // I am single <span class="keyword">value</span></div><div class="line">  &#125;);</div></pre></td></tr></table></figure></p>
<h4 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h4><p><code>merge</code> 方法能将两个 stream 进行合并<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Rx.Observable.<span class="built_in">merge</span>(singleValue, streamFromPromise)</div><div class="line">  .subscribe(<span class="function"><span class="keyword">function</span><span class="params">(value)</span></span> &#123;</div><div class="line">    console.<span class="built_in">log</span>(<span class="keyword">value</span>);</div><div class="line">    // I am single <span class="keyword">value</span></div><div class="line">    // I am simple promise</div><div class="line">  &#125;);</div></pre></td></tr></table></figure></p>
<p>即两个 stream，只要有 emit 值，合并后的 stream 就会触发 emit</p>
<p>还有另的写法，结果是一样的<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">singleValue.<span class="built_in">merge</span>(streamFromPromise)</div><div class="line">  .subscribe(<span class="function"><span class="keyword">function</span><span class="params">(value)</span></span> &#123;</div><div class="line">    console.<span class="built_in">log</span>(<span class="keyword">value</span>);</div><div class="line">  &#125;);</div></pre></td></tr></table></figure></p>
<p>我们可以看出，这个很像是给 streamFromPromise 赋了一个初始值，在执行异步操作后又给了返回值，Rx 提供了一个方法来给 stream 赋初始值<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">streamFromPromise.startWith(<span class="string">'initial value'</span>)</div><div class="line">  .subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(value);</div><div class="line">    <span class="comment">// initial value</span></div><div class="line">    <span class="comment">// I am simple promise</span></div><div class="line">  &#125;);</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上就是对 Rxjs 的初步学习，主要是理解了其思路，将所有的东西都化作 stream 去操作，可以有很多便捷的方法来组织和聚合数据，最后绑定到 view 上，实现对界面展示的控制。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/16/React-实践：改造-Redux-action-generator，编写-Redux-reducer-generator-（2）/" itemprop="url">
                  React 实践：改造 Redux action generator，编写 Redux reducer generator (2)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2017-02-16T15:31:59+08:00" content="2017-02-16">
              2017-02-16
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>接上一篇博文，我们来探讨一下怎么通过配置来生成 <code>reducer</code>，以及如何往自动生成的 <code>reducer</code> 中增加自定义的转换（<code>action</code> 触发 <code>reducer</code> 变化）</p>
<h3 id="reducer-的组成"><a href="#reducer-的组成" class="headerlink" title="reducer 的组成"></a>reducer 的组成</h3><ul>
<li>在上一篇博文中，我们通过 action 的配置，自动生成了一些 reducer，这一部分我们称为<code>来自 action 配置的 reducer</code></li>
<li>我们自定义的 reducer，需要定义名字以及它对应的通过 action 之后的转换(nextState)</li>
<li>由 action 配置自动生成的 reducer，我们往其中增加一些转换规则</li>
</ul>
<h3 id="完善-reducer-generator"><a href="#完善-reducer-generator" class="headerlink" title="完善 reducer_generator"></a>完善 reducer_generator</h3><p>我们可以把 reducer 的配置分为两部分：basics(自定义 reducer) 和 extras(往自动生成的 reducer 中添加规则)<br>basics 和 extras 的配置规则差不多，不同的是 basics 的每个元素多了一个 initialState 属性，如下例子所示<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    name: <span class="symbol">'globalLoading</span>',</div><div class="line">    initialState: &#123;</div><div class="line">      show: false,</div><div class="line">      msg: '</div><div class="line">    &#125;,</div><div class="line">    mappers: [</div><div class="line">      &#123;</div><div class="line">        action: <span class="symbol">'showLoading</span>',</div><div class="line">        nextState: (<span class="name">state</span>, action) =&gt; (&#123;</div><div class="line">          show: true,</div><div class="line">          msg: action.data || <span class="symbol">'loading</span>'</div><div class="line">        &#125;)</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        action: <span class="symbol">'hideLoading</span>',</div><div class="line">        nextState: (<span class="name">state</span>, action) =&gt; (&#123;</div><div class="line">          show: false,</div><div class="line">          msg: ''</div><div class="line">        &#125;)</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>和我们原来写 reducer 的方式很像，只不过变成了配置，简化了代码。<br>最终的 reducer 通过这个函数暴露出去<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="builtin-name">export</span><span class="built_in"> default </span>(prefix, actionConfigs, reducerConfigs) =&gt; &#123;</div><div class="line">  const result = &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="keyword">forEach</span>(action =&gt;</div><div class="line">    addReducersFromAction(prefix, action, result, reducerConfigs.extras || [], actionLoadingList)</div><div class="line">  )(actionConfigs);</div><div class="line"></div><div class="line">  <span class="keyword">forEach</span>(reducer =&gt;</div><div class="line">    addReducersFromBasicConfigs(prefix, reducer, result)</div><div class="line">  )(reducerConfigs.basics || []);</div><div class="line"></div><div class="line">  return result;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="自定义-reducer"><a href="#自定义-reducer" class="headerlink" title="自定义 reducer"></a>自定义 reducer</h4><p>其实也就是实现 <code>addReducersFromBasicConfigs</code> 函数，很简单，代码如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> addReducersFromBasicConfigs = <span class="function">(<span class="params">prefix, reducer, result</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> &#123;</div><div class="line">    name, initialState, mappers</div><div class="line">  &#125; = reducer;</div><div class="line"></div><div class="line">  result[<span class="string">`<span class="subst">$&#123;name&#125;</span>`</span>] = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, length = mappers.length; i &lt; length; i ++) &#123;</div><div class="line">      <span class="keyword">const</span> mapper = mappers[i];</div><div class="line">      <span class="keyword">if</span> (action.type === getAction(prefix, <span class="string">`<span class="subst">$&#123;mapper.action&#125;</span>`</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> mapper.nextState(state, action);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> state;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="补充自动生成的-reducer-规则"><a href="#补充自动生成的-reducer-规则" class="headerlink" title="补充自动生成的 reducer 规则"></a>补充自动生成的 reducer 规则</h4><p>我们在上一篇博文已经看到了，对于每一种类型的 action，都有对应的 reducer_generator 代码。<br>为了实现规则的补充，我们让自动生成的 reducer 在经过自动生成的规则的判断之后，返回一个函数。<br>比如 loading 的代码，我们修改如下<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">result[`$&#123;<span class="keyword">name</span>&#125;Loading`] = (state = false, <span class="keyword">action</span>) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, <span class="keyword">name</span>, defines.ACTION_STATUS_LOAD)) &#123;</div><div class="line">    <span class="keyword">return</span> true;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, <span class="keyword">name</span>, defines.ACTION_STATUS_SUCCESS)) &#123;</div><div class="line">    <span class="keyword">return</span> false;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, <span class="keyword">name</span>, defines.ACTION_STATUS_FAIL)) &#123;</div><div class="line">    <span class="keyword">return</span> false;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> getExtraMapper(prefix, `$&#123;<span class="keyword">name</span>&#125;Loading`, state, <span class="keyword">action</span>, extras);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>其中，getExtraMapper 函数就是我们处理自定义规则的地方。该函数代码如下<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">const getExtraMapper = (<span class="keyword">prefix, </span>name, state, action, <span class="keyword">extras) </span>=&gt; &#123;</div><div class="line">  for (let i = <span class="number">0</span>, length = <span class="keyword">extras.length; </span>i &lt; length<span class="comment">; i ++) &#123;</span></div><div class="line">    const <span class="keyword">extra </span>= <span class="keyword">extras[i];</span></div><div class="line">    if (<span class="keyword">extra.name </span>=== name) &#123;</div><div class="line">      for (let <span class="keyword">j </span>= <span class="number">0</span>, mappersLength = <span class="keyword">extra.mappers.length; </span><span class="keyword">j </span>&lt; mappersLength<span class="comment">; j ++) &#123;</span></div><div class="line">        const mapper = <span class="keyword">extra.mappers[j];</span></div><div class="line">        if (action.type === getAction(<span class="keyword">prefix, </span>mapper.action)) &#123;</div><div class="line">          return mapper.nextState(state, action)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return state<span class="comment">;</span></div><div class="line">&#125;<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>思路很简单，就是遍历 extras 的配置，从中寻找匹配的 name，然后将规则添加进去，是不是很简单？</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>至此，我们就实现了通过配置生成所有的 action 和 reducer 的方法，让项目代码量骤减，开发效率也提高了不少。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/25/React-实践：改造-Redux-action-generator，编写-Redux-reducer-generator-(1)/" itemprop="url">
                  React 实践：改造 Redux action generator，编写 Redux reducer generator (1)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2017-01-25T09:09:25+08:00" content="2017-01-25">
              2017-01-25
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>从几个月前开始，写了一篇博文 <code>编写自己项目的 Redux action generator</code>，并且在项目实践中用上了，大大减少了编写 <code>action</code> 时的代码量，提高了开发效率。可是对于 <code>reducer</code>，还是需要手写很多东西，这其中也有很多类似的代码，因此，在上个项目告一段落后，开始构思如何通过类似的方式，用配置生成 <code>reducer</code>。</p>
<h3 id="原有的写法"><a href="#原有的写法" class="headerlink" title="原有的写法"></a>原有的写法</h3><p>以项目中一个用户模块为例，它的 reducer 如下：<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">export <span class="keyword">default</span> combineReducers(&#123;</div><div class="line">  <span class="built_in">list</span>: (state = [], <span class="built_in">action</span>) =&gt; &#123;</div><div class="line">    <span class="keyword">switch</span> (<span class="built_in">action</span>.<span class="built_in">type</span>) &#123;</div><div class="line">      <span class="keyword">case</span> getAction(<span class="built_in">NAME</span>, <span class="string">'list'</span>, defines.ACTION_STATUS_LOAD):</div><div class="line">        return [];</div><div class="line">      <span class="keyword">case</span> getAction(<span class="built_in">NAME</span>, <span class="string">'list'</span>, defines.ACTION_STATUS_SUCCESS):</div><div class="line">        return Object.assign([], state, <span class="built_in">action</span>.response.data.tenantAdmins);</div><div class="line">      <span class="keyword">default</span>:</div><div class="line">        return state;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  listLoading: (state = <span class="literal">false</span>, <span class="built_in">action</span>) =&gt; &#123;</div><div class="line">    <span class="keyword">switch</span> (<span class="built_in">action</span>.<span class="built_in">type</span>) &#123;</div><div class="line">      <span class="keyword">case</span> getAction(<span class="built_in">NAME</span>, <span class="string">'list'</span>, defines.ACTION_STATUS_LOAD):</div><div class="line">        return <span class="literal">true</span>;</div><div class="line">      <span class="keyword">case</span> getAction(<span class="built_in">NAME</span>, <span class="string">'list'</span>, defines.ACTION_STATUS_SUCCESS):</div><div class="line">      <span class="keyword">case</span> getAction(<span class="built_in">NAME</span>, <span class="string">'list'</span>, defines.ACTION_STATUS_FAIL):</div><div class="line">        return <span class="literal">false</span>;</div><div class="line">      <span class="keyword">default</span>:</div><div class="line">        return state;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  ···</div></pre></td></tr></table></figure></p>
<p>其中，<code>getAction</code> 方法是获取全局唯一的 <code>action</code> 值，此处不细说。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>可以看到，<code>list</code> 和 <code>listLoading</code> 是很常见的 <code>reducer</code>，几乎在所有列表页面都会出现，而且是伴随着 <code>list</code> 这个 <code>action</code> 出现的。仔细去回忆不难发现，我们所有定义的 <code>action</code>，基本都会需要 <code>reducer</code> 与之配合使用。那么，我们就可以从 <code>action</code> 的配置出发，来生成一些通用的 <code>reducer</code>。</p>
<h4 id="异步-action"><a href="#异步-action" class="headerlink" title="异步 action"></a>异步 action</h4><p>这里指的是需要请求服务器获取数据的异步操作，我们原有的 <code>action</code> 是这么写的<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'list'</span>,</div><div class="line">  <span class="attribute">isAjax</span>: true,</div><div class="line">  <span class="attribute">path</span>: <span class="string">'apis/notice'</span>,</div><div class="line">  <span class="attribute">method</span>: <span class="string">'GET'</span>,</div><div class="line">  <span class="attribute">msgType</span>: defines.AJAX_TYPE_LOAD</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据需求的不同，我们在模块中可能会添加这些 <code>reducer</code>：</p>
<ul>
<li>listData</li>
<li>listLoading</li>
<li>listCurPage</li>
<li>listTotal</li>
<li>listFilter</li>
</ul>
<p>其中，<code>listCurPage</code> 和 <code>listFilter</code> 需要额外的 <code>action</code> 与之配合使用。所以，我们添加以下配置，让异步 <code>action</code> 的配置能够自动生成我们想要的 <code>action</code> 和 <code>reducer</code></p>
<ul>
<li><p>data: {initialState, nextState(state, action)}</p>
<ul>
<li>这个配置代表这个 <code>action</code> 需要在其请求成功后存储数据到 <code>reducer</code> 中</li>
<li>约定生成的 <code>reducer</code> 名称为 <code>${name}Data</code></li>
<li>initialState 配置该 <code>reducer</code> 的初始值</li>
<li><code>nextState(state, action)</code> 是一个函数，配置触发 <code>getAction(prefix, name, defines.ACTION_STATUS_SUCCESS)</code> 后 <code>reducer</code> 的响应</li>
<li>代码<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">result[`$&#123;name&#125;Data`] = (<span class="keyword">state</span> = data.initialState, action) =&gt; &#123;</div><div class="line">  if (action.type === getAction(prefix, name, defines.ACTION_STATUS_SUCCESS)) &#123;</div><div class="line">    return data.nextState(<span class="keyword">state</span>, action);</div><div class="line">  &#125;</div><div class="line">  return <span class="keyword">state</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></li>
</ul>
<p>（其中，<code>result</code> 是最终传给 <code>combineReducers</code> 的一个对象，下文同理）</p>
</li>
<li><p>loading: true</p>
<ul>
<li>这个配置代表这个 <code>action</code> 需要一个与之对应的 <code>loading</code> 状态标识</li>
<li>约定生成的 <code>reducer</code> 名称为 <code>${name}Loading</code></li>
<li>自动配置触发 <code>getAction(prefix, name, defines.ACTION_STATUS_LOAD)</code> 时返回 <code>true</code>, 触发 <code>getAction(prefix, name, defines.ACTION_STATUS_SUCCESS)</code> 和 <code>getAction(prefix, name, defines.ACTION_STATUS_FAIL)</code> 时返回 <code>false</code></li>
<li>代码<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">result[`$&#123;<span class="keyword">name</span>&#125;Loading`] = (state = false, <span class="keyword">action</span>) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, <span class="keyword">name</span>, defines.ACTION_STATUS_LOAD)) &#123;</div><div class="line">    <span class="keyword">return</span> true;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, <span class="keyword">name</span>, defines.ACTION_STATUS_SUCCESS)) &#123;</div><div class="line">    <span class="keyword">return</span> false;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, <span class="keyword">name</span>, defines.ACTION_STATUS_FAIL)) &#123;</div><div class="line">    <span class="keyword">return</span> false;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> state;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>pagination: true</p>
<ul>
<li>这个配置代表这个 <code>action</code> 需要分页获取数据</li>
<li>约定生成 <code>${name}CurPage</code> 和 <code>${name}Total</code> 两个 <code>reducer</code></li>
<li>自动生成新的 <code>action</code>: <code>set${toCamel(name)}Page</code> (toCamel 函数是将传入的 name 转化为首字母大写的形式，为了符合整个驼峰式的要求，下文同理)</li>
<li>约定该请求返回的数据中，要带上 count 代表数据的总量，在触发 <code>getAction(prefix, name, defines.ACTION_STATUS_SUCCESS)</code> 时，将该值设置到 <code>${name}Total</code> 中去</li>
<li>调用 <code>set${toCamel(name)}Page</code> 时，<code>${name}CurPage</code> 返回 <code>action.data</code></li>
<li>action_generator 代码<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Page`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Page`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Page`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Page`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></li>
</ul>
<p>（其中，<code>result</code> 是最终的 action 文件 export 出去的对象，包含所有的 <code>action</code>，下文同理）</p>
<ul>
<li>reducer_generator 代码<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">result[`$&#123;<span class="keyword">name</span>&#125;Total`] = (state = <span class="number">0</span>, <span class="keyword">action</span>) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, <span class="keyword">name</span>, defines.ACTION_STATUS_SUCCESS)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">action</span>.response.<span class="keyword">data</span>.<span class="built_in">count</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> state;</div><div class="line">&#125;;</div><div class="line">result[`$&#123;<span class="keyword">action</span>.<span class="keyword">name</span>&#125;CurPage`] = (state = <span class="number">1</span>, <span class="keyword">action</span>) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, `set$&#123;toCamel(<span class="keyword">name</span>)&#125;Page`)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">action</span>.<span class="keyword">data</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> state;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>filter: true</p>
<ul>
<li>这个配置代表这个 <code>action</code> 需要筛选功能，在发出请求时带上筛选条件</li>
<li>约定生成的 <code>reducer</code> 名称为 <code>${name}Filter</code></li>
<li>自动生成 <code>set${toCamel(name)}Filter</code> 和 <code>clear${toCamel(name)}Filter</code> 两个 <code>action</code></li>
<li>约定 <code>filter</code> 为一个 <code>Object</code>，初始值为 <code>{}</code></li>
<li>调用 <code>set${toCamel(name)}Filter</code> 时，<code>${name}Filter</code> 返回 <code>action.data</code></li>
<li>调用 <code>clear${toCamel(name)}Filter</code> 时，<code>${name}Filter</code> 返回 <code>{}</code></li>
<li><p>action_generator 代码<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>Filter`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
</li>
<li><p>reducer_generator 代码<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">result[`$&#123;<span class="keyword">action</span>.<span class="keyword">name</span>&#125;Filter`] = (state = &#123;&#125;, <span class="keyword">action</span>) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, `set$&#123;toCamel(<span class="keyword">name</span>)&#125;Filter`)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">action</span>.<span class="keyword">data</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, `clear$&#123;toCamel(<span class="keyword">name</span>)&#125;Filter`)) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;&#125;;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> state;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
</li>
</ul>
</li>
</ul>
<h4 id="弹框类或切换显示类-action"><a href="#弹框类或切换显示类-action" class="headerlink" title="弹框类或切换显示类 action"></a>弹框类或切换显示类 action</h4><p>这里指的是 action 需要控制某些组件的显示或隐藏，我们原有的 <code>action</code> 是这么写的<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'showForm'</span></div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'hideForm'</span></div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'toggleForm'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里需要写两个或三个 <code>action</code>，并且需要在 <code>reducer</code> 中去手动编写对应关系<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">formShow: <span class="function">(<span class="params">state = <span class="literal">false</span>, action</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">    <span class="keyword">case</span> getAction(NAME, <span class="string">'showForm'</span>):</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    <span class="keyword">case</span> getAction(NAME, <span class="string">'hideForm'</span>):</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">case</span> getAction(NAME, <span class="string">'toggleForm'</span>):</div><div class="line">      <span class="keyword">return</span> !state;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> state;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们将其视为一种类型的 <code>action</code></p>
<ul>
<li>约定生成 <code>show${toCamel(name)}</code> <code>hide${toCamel(name)}</code> <code>toggle${toCamel(name)}</code> 三个 <code>action</code> 用来控制</li>
<li>约定生成的 reducer 为 <code>${name}Show</code></li>
<li><p>action_generator 代码<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`show<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`show<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`show<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`show<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`hide<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`hide<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`hide<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`hide<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`toggle<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`toggle<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`toggle<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`toggle<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
</li>
<li><p>reducer_generator 代码<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">result[<span class="string">`<span class="subst">$&#123;name&#125;</span>Show`</span>] = <span class="function">(<span class="params">state = <span class="literal">false</span>, action</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span> (action.type === getAction(prefix, <span class="string">`show<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (action.type === getAction(prefix, <span class="string">`hide<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (action.type === getAction(prefix, <span class="string">`toggle<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> !state;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> getExtraMapper(prefix, <span class="string">`<span class="subst">$&#123;name&#125;</span>Show`</span>, state, action, extras);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h4 id="设置类-action"><a href="#设置类-action" class="headerlink" title="设置类 action"></a>设置类 action</h4><p>这里指的是 action 需要设置某些值到 <code>reducer</code> 中，我们原有的 <code>action</code> 是这么写的<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'setSelected'</span></div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">  <span class="attribute">name</span>: <span class="string">'clearSelected'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里需要写两个 <code>action</code>，并且需要在 <code>reducer</code> 中去手动编写对应关系<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">selected: (state = <span class="string">''</span>, <span class="built_in">action</span>) =&gt; &#123;</div><div class="line">  <span class="keyword">switch</span> (<span class="built_in">action</span>.<span class="built_in">type</span>) &#123;</div><div class="line">    <span class="keyword">case</span> getAction(<span class="built_in">NAME</span>, <span class="string">'setSelected'</span>):</div><div class="line">      return <span class="built_in">action</span>.data;</div><div class="line">    <span class="keyword">case</span> getAction(<span class="built_in">NAME</span>, <span class="string">'clearSelected'</span>):</div><div class="line">      return <span class="string">''</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      return state;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们将其视为一种类型的 <code>action</code></p>
<ul>
<li>约定生成 <code>set${toCamel(name)}</code> <code>clear${toCamel(name)}</code> 两个 <code>action</code></li>
<li>约定生成的 reducer 为 <code>${name}Show</code></li>
<li><p>action_generator 代码<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`set<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div><div class="line"><span class="built_in">Object</span>.assign(result, &#123;</div><div class="line">  [getAction(actionPrefix, <span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>)]:</div><div class="line">    getAction(actionPrefix, <span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line"></div><div class="line">  [<span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">    <span class="keyword">type</span>: getAction(actionPrefix, <span class="string">`clear<span class="subst">$&#123;toCamel(name)&#125;</span>`</span>),</div><div class="line">    data</div><div class="line">  &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
</li>
<li><p>reducer_generator 代码<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">result[`$&#123;<span class="keyword">name</span>&#125;`] = (state = initialState, <span class="keyword">action</span>) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, `set$&#123;toCamel(<span class="keyword">name</span>)&#125;`)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">action</span>.<span class="keyword">data</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">action</span>.<span class="keyword">type</span> === getAction(prefix, `clear$&#123;toCamel(<span class="keyword">name</span>)&#125;`)) &#123;</div><div class="line">    <span class="keyword">return</span> initialState;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> getExtraMapper(prefix, `$&#123;<span class="keyword">name</span>&#125;`, state, <span class="keyword">action</span>, extras);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上就是通过 <code>action</code> 的配置来生成一些常用的 <code>reducer</code> 和 额外的 <code>action</code> 的做法，那不通过 <code>action</code> ，直接通过配置来生成 <code>reducer</code> 需要怎么做呢？想要往自动生成的 <code>reducer</code> 中增加自定义的转换（<code>action</code> 触发 <code>reducer</code> 变化）应该怎么做呢？下一篇博文我们再来一同探究。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/07/React-实践：第三方方法调用类库的改造/" itemprop="url">
                  React 实践：第三方方法调用类库的改造
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2017-01-07T08:56:22+08:00" content="2017-01-07">
              2017-01-07
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>我们知道，React 组件的常规渲染是根据传入的 props 来改变的，但有时候，我们会需要使用一些第三方库，它们提供了一些方法来操作 dom （新增或修改）以改变页面展示，这时候就需要我们做一次转化，使之能符合 React 的常规做法。下面就以 <a href="https://ant.design/" target="_blank" rel="external">Ant-design</a> 的 <code>message</code> 方法为例，介绍一下改造的实践过程。</p>
<h3 id="message-的调用方法"><a href="#message-的调用方法" class="headerlink" title="message 的调用方法"></a>message 的调用方法</h3><p>根据文档的介绍，使用 <code>message</code> 方法产生一个全局 loading 的代码如下<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> hide = message.loading(<span class="string">'Action in progress..'</span>, <span class="number">0</span>);</div><div class="line"><span class="comment">// Dismiss manually and asynchronously</span></div><div class="line"><span class="built_in">setTimeout</span>(hide, <span class="number">2500</span>);</div></pre></td></tr></table></figure></p>
<p>非常简单，而我们不想在 React 逻辑代码中写类似的方法调用，只想通过 action 改变 store 的状态，来显示和隐藏这个 <code>loading</code>。</p>
<h3 id="定义Loading-组件"><a href="#定义Loading-组件" class="headerlink" title="定义Loading 组件"></a>定义Loading 组件</h3><p>首先，我们希望组件接受两个属性，<code>show</code> 代表显示与否，<code>content</code> 代表显示的文本内容<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="type">React</span>, &#123;<span class="type">Component</span>, <span class="type">PropTypes</span>&#125; from <span class="symbol">'reac</span>t';</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Loading</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  constructor(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="type">Loading</span>.propTypes = &#123;</div><div class="line">  show: <span class="type">PropTypes</span>.bool.isRequired,</div><div class="line">  content: <span class="type">PropTypes</span>.string</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export <span class="keyword">default</span> <span class="type">Loading</span>;</div></pre></td></tr></table></figure></p>
<h3 id="强制渲染一次"><a href="#强制渲染一次" class="headerlink" title="强制渲染一次"></a>强制渲染一次</h3><p>我们是使用第三方库提供的方法来显示和隐藏 <code>loading</code> 内容的，我们就不希望 React 根据 props 来自动渲染组件，以造成不希望出现的现象<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shouldComponentUpdate(nextProps, nextState) &#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="逻辑实现"><a href="#逻辑实现" class="headerlink" title="逻辑实现"></a>逻辑实现</h3><p>既然我们限制了组件只渲染一次，那我们应该在哪里去进行方法调用呢？我们是希望根据 props 来改变，所以答案很简单：<code>componentWillReceiveProps</code><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">componentWillReceiveProps(nextProps) &#123;</div><div class="line">  <span class="keyword">if</span> (nextProps.show) &#123;</div><div class="line">    <span class="keyword">this</span>.hide = message.loading(nextProps.content || <span class="string">'loading'</span>, <span class="number">0</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">this</span>.hide &amp;&amp; <span class="keyword">this</span>.hide();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，hide 方法是 Ant-design 提供的隐藏该 <code>loading</code> 的方法，我们在 <code>show = false</code> 的时候，执行该方法即可实现 <code>loading</code> 的隐藏。最后，我们再添加 <code>this.hide</code> 的初始化<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">constructor</span><span class="params">(props)</span> <span class="comment">&#123;</span></span></div><div class="line">  super(props);</div><div class="line">  this.hide = () =&gt; &#123;&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>我们实现的 Loading 组件整体代码如下<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="type">React</span>, &#123;<span class="type">Component</span>, <span class="type">PropTypes</span>&#125; from <span class="symbol">'reac</span>t';</div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123;message&#125; from <span class="symbol">'ant</span>d';</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Loading</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  constructor(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">this</span>.hide = () =&gt; &#123;&#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  componentWillReceiveProps(nextProps) &#123;</div><div class="line">    <span class="keyword">if</span> (nextProps.show) &#123;</div><div class="line">      <span class="keyword">this</span>.hide = message.loading(nextProps.content || <span class="symbol">'loadin</span>g', <span class="number">0</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">this</span>.hide &amp;&amp; <span class="keyword">this</span>.hide();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  shouldComponentUpdate(nextProps, nextState) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="type">Loading</span>.propTypes = &#123;</div><div class="line">  show: <span class="type">PropTypes</span>.bool.isRequired,</div><div class="line">  content: <span class="type">PropTypes</span>.string</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export <span class="keyword">default</span> <span class="type">Loading</span>;</div></pre></td></tr></table></figure></p>
<p>只需要把组件在页面最上层引入，并且传入 <code>store</code> 中的 <code>show</code> <code>content</code> 两个值即可，思路清晰，也使得 React 代码变得更加纯粹和可读了</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/React-实践：编写自己项目的-Redux-action-generator/" itemprop="url">
                  React 实践：编写自己项目的 Redux action generator
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2016-08-17T19:47:08+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>使用 <code>React</code> ＋ <code>Redux</code> 也有一段时间了，从第一次尝试使用之后就开始按一种方式写代码，思路很清晰，但就是有一个问题，感觉每写一个 action 都是在 <code>copy</code> ＋ <code>paste</code>，然后修改其中的部分内容，最近想优化代码所以尝试着编写一个 <code>generator</code> 来生成这些 <code>actions</code>，让代码更加优雅。</p>
<h3 id="原有的写法"><a href="#原有的写法" class="headerlink" title="原有的写法"></a>原有的写法</h3><p>这是一个 action 的部分代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> USER_LIST_LOAD = <span class="string">'USER_LIST_LOAD'</span>;</div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> USER_LIST_SUCCESS = <span class="string">'USER_LIST_SUCCESS'</span>;</div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> USER_LIST_FAIL = <span class="string">'USER_LIST_FAIL'</span>;</div><div class="line"></div><div class="line">exports.loadUserList = <span class="function">(<span class="params">tenantId, sucCallback, errCallback</span>) =&gt;</span></div><div class="line">  (dispatch, getState) =&gt;</div><div class="line">  dispatch(&#123;</div><div class="line">    [CALL_API]: &#123;</div><div class="line">      <span class="attr">types</span>: [</div><div class="line">        USER_LIST_LOAD,</div><div class="line">        USER_LIST_SUCCESS,</div><div class="line">        USER_LIST_FAIL</div><div class="line">      ],</div><div class="line">      <span class="attr">endpoint</span>: <span class="string">`apis/<span class="subst">$&#123;tenantId&#125;</span>/user`</span>,</div><div class="line">      <span class="attr">schema</span>: Schemas.NORMAL_RESP,</div><div class="line">      <span class="attr">method</span>: <span class="string">'GET'</span>,</div><div class="line">      <span class="attr">errMsg</span>: <span class="string">'获取数据失败，请刷新重试'</span>,</div><div class="line">      sucCallback,</div><div class="line">      errCallback</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> USER_LIST_SELECT = <span class="string">'USER_LIST_SELECT'</span>;</div><div class="line">exports.userListSelect = <span class="function"><span class="params">keys</span> =&gt;</span> (&#123;</div><div class="line">  <span class="attr">type</span>: USER_LIST_SELECT,</div><div class="line">  keys</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ul>
<li>每一个 <code>action</code> 无非就是 export 出在全局唯一的常量作为 action 的标识，并且提供可以调用的方法来 dispatch 这样的常量。这里的 action 分为两类，ajax 请求类和非 ajax 请求类，ajax 请求类会 export 3 个常量，分别代表 请求中，请求成功以及请求失败 3 个状态。</li>
<li>传进来的参数，应该要统一成一个（ajax 请求的数据都放在第一个参数里，第二个和第三个固定为成功回调和失败回调）。</li>
<li>为了保证 action 的唯一性，我们需要传入一个参数作为前缀，一般用页面名作为前缀（这里是 USER）。</li>
<li>为了用配置的方式写 actions，考虑把 actions 用 json 数组的方式传进来，这样可以用到 map 函数来遍历并且生成每一个 action。<br>－ 最后要将所有的 action 组装成一个变量 export 出去，再对原有的 import 方法进行修改就可以了。</li>
</ul>
<h3 id="generator-代码"><a href="#generator-代码" class="headerlink" title="generator 代码"></a>generator 代码</h3><p>首先，根据是否 ajax 请求，生成对应的 action<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> actionList = <span class="function">(<span class="params">actionPrefix, actions</span>) =&gt;</span></div><div class="line">  map(<span class="function"><span class="params">action</span> =&gt;</span></div><div class="line">    action.isAjax ? (&#123;</div><div class="line">      [<span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_LOAD`</span>]:</div><div class="line">        <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_LOAD`</span>,</div><div class="line">      [<span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_SUCCESS`</span>]:</div><div class="line">        <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_SUCCESS`</span>,</div><div class="line">      [<span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_FAIL`</span>]:</div><div class="line">        <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_FAIL`</span>,</div><div class="line">      [action.name]: <span class="function">(<span class="params">data, sucCallback, errCallback</span>) =&gt;</span></div><div class="line">        (dispatch, getState) =&gt;</div><div class="line">          dispatch(&#123;</div><div class="line">            [CALL_API]: &#123;</div><div class="line">              <span class="attr">types</span>: [</div><div class="line">                <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_LOAD`</span>,</div><div class="line">                <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_SUCCESS`</span>,</div><div class="line">                <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name.toUpperCase()&#125;</span>_FAIL`</span></div><div class="line">              ],</div><div class="line">              <span class="attr">endpoint</span>: action.path,</div><div class="line">              <span class="attr">schema</span>: action.schema || Schemas.NORMAL_RESP,</div><div class="line">              <span class="attr">method</span>: action.method,</div><div class="line">              <span class="attr">errMsg</span>: action.errMsg || <span class="string">'获取数据失败，请刷新重试'</span>,</div><div class="line">              data,</div><div class="line">              sucCallback,</div><div class="line">              errCallback</div><div class="line">            &#125;</div><div class="line">          &#125;)</div><div class="line">    &#125;) : (&#123;</div><div class="line">      [<span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name&#125;</span>`</span>]:</div><div class="line">        <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name&#125;</span>`</span>,</div><div class="line">      [action.name]: <span class="function"><span class="params">data</span> =&gt;</span> (&#123;</div><div class="line">        <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;actionPrefix&#125;</span>_<span class="subst">$&#123;action.name&#125;</span>`</span>,</div><div class="line">        data</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">  )(actions);</div></pre></td></tr></table></figure></p>
<ul>
<li>传进来的参数有两个，一个 <code>actionPrefix</code>，一个包含每个 action 信息的数组</li>
<li>对每个 action 来说，<code>isAjax</code> 用来区分是否 ajax 请求; <code>name</code> 是 action 的名字，需要是唯一的; <code>path</code> 和 <code>method</code> 分别代表 ajax 请求的地址和方法（get、post 等）</li>
<li>这里的 <code>map</code> 函数来自于 <code>ramda</code> 库</li>
</ul>
<p>然后，将上面生成的 action 数组合并起来并 export 出去<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> (actionPrefix, actions) =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> result = &#123;&#125;;</div><div class="line">  forEach(<span class="function"><span class="params">action</span> =&gt;</span></div><div class="line">    <span class="built_in">Object</span>.assign(result, action)</div><div class="line">  )(actionList(actionPrefix, actions));</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li>这里定义了该文件 export 一个函数，接收两个参数</li>
<li>这个函数能够先通过传进来的 actions 生成一系列方法和变量，然后组装起来</li>
<li>这里的 <code>forEach</code> 函数来自于 <code>ramda</code> 库</li>
</ul>
<p>最后，真正的 action 文件只需这样 <code>配置</code> 就能实现原有代码的功能<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> generator <span class="keyword">from</span> <span class="string">'./generator'</span>;</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> generator(<span class="string">'USER'</span>, [</div><div class="line">  &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">'list'</span>,</div><div class="line">    <span class="attr">isAjax</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">path</span>: <span class="string">'apis/user'</span>,</div><div class="line">    <span class="attr">method</span>: <span class="string">'GET'</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">'listSelect'</span></div><div class="line">  &#125;</div><div class="line">];</div></pre></td></tr></table></figure></p>
<h3 id="新的问题"><a href="#新的问题" class="headerlink" title="新的问题"></a>新的问题</h3><p>如果 <code>action</code> 的 <code>path</code> 里需要通过部分参数来组装时，就需要再优化 <code>generator</code> 了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> getPath = <span class="function">(<span class="params">path, data</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> replaceStrings = path.match(<span class="regexp">/\$\&#123;\w*\&#125;/g</span>);</div><div class="line">  <span class="keyword">if</span> (!replaceStrings) <span class="keyword">return</span> path;</div><div class="line">  <span class="keyword">let</span> result = path;</div><div class="line">  forEach(<span class="function"><span class="params">replaceString</span> =&gt;</span></div><div class="line">    result = result.replace(replaceString,</div><div class="line">      data[replaceString.substring(<span class="number">2</span>, replaceString.length - <span class="number">1</span>)])</div><div class="line">  )(replaceStrings);</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>先定义这样一个方法，然后再将原有函数的 <code>endpoint</code> 修改一下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">endpoint: getPath(action.path, data),</div></pre></td></tr></table></figure></p>
<ul>
<li>这个函数是利用正则，将 <code>path</code> 中符合 <code>${param}</code> 格式的参数用 <code>data</code> 里面对应的 <code>key</code> 的值替换掉，这样就实现了原有的 <code>apis/${tenantId}/user</code> ES6 模板字符串的写法</li>
<li>要保证调用 <code>action</code> 时候的第一个参数，即 <code>data</code>，含有这些需要转换的参数</li>
</ul>
<p>最终实现这样的 action，只需要这样配置<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">name</span>: <span class="string">'list'</span>,</div><div class="line">  <span class="attr">isAjax</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">path</span>: <span class="string">'apis/$&#123;tenantId&#125;/user'</span>,</div><div class="line">  <span class="attr">method</span>: <span class="string">'GET'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用时候的示例<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> userActions <span class="keyword">from</span> <span class="string">'../../actions/user'</span>;</div><div class="line">userActions.list(&#123;</div><div class="line">  <span class="attr">tenantId</span>: <span class="string">'11223344'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>经过了这样的改造，代码真的优雅了不少，真正实现了用配置的方式来编写业务，很有成就感。对于这样的项目来讲，只要定好规范，新人很快上手写 <code>action</code> 不是梦。</li>
<li>平时写的代码多了，就要多注意这些一直在 <code>copy</code> 和 <code>paste</code> 的代码，看看是否能够抽取出公共的部分来让代码更加优雅，这才是编程的艺术。</li>
<li>写一个 <code>generator</code> 没那么容易，需要考虑各种情况，还要结合实际权衡，让其能更加通用，具备较强可复用性。另外，反复地斟酌和优化代码是必不可少的过程。</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/01/React-优化实践/" itemprop="url">
                  React 优化实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2016-08-01T20:07:54+08:00" content="2016-08-01">
              2016-08-01
            </time>
          </span>

          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在用 React ＋ Redux ＋ WEUI 做一个企业号上的企业系统移动端版本，发现在性能较差的手机上还是有蛮大的卡顿，故开始查找资料想办法进行优化。</p>
<h2 id="why-did-you-update"><a href="#why-did-you-update" class="headerlink" title="why-did-you-update"></a>why-did-you-update</h2><p>无意中看到某大神 Star 了这个项目，一开始还没有特别注意，后来在某博文上又看到该工具的推荐。该工具可以在你的组件每次 <code>reRender</code> 的时候，对比该组件的 <code>props</code>，如果没有变化，会告诉你这是不必要的 <code>reRender</code>。<a href="https://github.com/garbles/why-did-you-update" target="_blank" rel="external">点此进入项目</a><br>工具的使用也特别简单，只需要在前端主文件中加入一句话，装饰一下 React。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">const</span> &#123;whyDidYouUpdate&#125; = <span class="built_in">require</span>(<span class="string">'why-did-you-update'</span>);</div><div class="line">whyDidYouUpdate(React);</div></pre></td></tr></table></figure>
<p>重新打开页面，发现加载了很久，这是由于 <code>why-did-you-update</code> 在浏览器上打印了很多的信息。不看不知道一看吓一跳，原来在我渲染页面的时候做了这么多无谓的 <code>reRender</code> 操作，真是浪费性能！</p>
<h2 id="ShouldComponentUpdate-优化"><a href="#ShouldComponentUpdate-优化" class="headerlink" title="ShouldComponentUpdate 优化"></a>ShouldComponentUpdate 优化</h2><p>那么多的 <code>reRender</code>，要怎么避免呢？<br>对于无状态组件来说，只需要重新实现该组件的 <code>ShouldComponentUpdate</code> 方法即可。<br><code>ShouldComponentUpdate</code> 默认返回的是 <code>true</code>，即默认当有新的 <code>props</code> 传入时，就执行 <code>reRender</code> 操作。我们要做的就是对比前一个 <code>props</code> 和新传入的 <code>props</code>，来决定是否返回 <code>true</code> 让组件更新。这里分几种情况：</p>
<p>－ 简单的字符串或者数字，直接使用 <code>JavaScript</code> 的 <code>＝＝＝</code> 对比即可<br>－ 对象或者数组，推荐使用 <code>lodash</code> 的 <code>isEqual</code> 函数，可以解决大多数情况下的比较<br>－ 复杂的深层的对象或数组，采用 <code>Immutable.js</code> 去进行比较<br>－ 特殊的，比如某些组件，如果组件的某个 <code>key</code> 不变（例如 id）就不进行更新，那我可以直接对比<code>props</code> 中我想要对比的这个属性即可</p>
<p>以上几种情况的前提，是在 <code>Redux</code> 中传递 <code>state</code> 的时候，对于对象或数组，使用 <code>Object.assign</code> 或者 <code>Immutable.js</code> 来传入一个新的引用，避免因为值不同但是引用地址相同，导致的错误比对。</p>
<h2 id="key"><a href="#key" class="headerlink" title="key"></a>key</h2><p>如果你在 <code>React</code> 中使用了循环去渲染一系列组件（例如列表），<code>React</code> 会提醒你对每一个组件设置一个唯一的 <code>key</code>。<code>React</code> 会根据这个 <code>key</code> 来判断组件的唯一性，如果两个 <code>key</code> 相同，则会只渲染一个组件。<br>其实这个 <code>key</code> 还有另外一个用途，就是判断组件是否需要 <code>reRender</code>。<code>React</code> 会根据这个 <code>key</code> 值来生成该组件的唯一标识，如果下次渲染的时候 <code>key</code> 值不变（即使位置变了），则会复用该组件，只有产生了新的 <code>key</code> 值，才会渲染新的组件。所以，我们也可以利用这个 <code>key</code> 值来避免组件的不必要删除和创建，复用组件以达到性能优化的目的。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>基本上进行了以上的优化，页面打开速度有了一定的提升，关键是能清楚地知道页面没有进行不必要的 <code>reRender</code>，在性能优化的路上前进了一步。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/14/记一次-react-页面白屏的排查过程/" itemprop="url">
                  记一次 react 页面白屏的排查过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Veröffentlicht am
            <time itemprop="dateCreated" datetime="2016-07-14T07:45:01+08:00" content="2016-07-14">
              2016-07-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; in
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/react-移动web-前端/" itemprop="url" rel="index">
                    <span itemprop="name">react 移动web 前端</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>近日，在 <code>微信web开发者工具</code> 开发完成页面后，在个人手机上测试通过并移交产品经理测试，发现其手机打开页面后白屏，手机型号同样是 iPhone6，拿了其他小伙伴的安卓手机发现也打不开，无论是在微信浏览器还是在 Safari 或者 安卓原生浏览器均是这样的现象。重新编译、清除缓存都无法解决这个问题。</p>
<h3 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h3><ul>
<li>一般情况下，前端无法渲染是由于 JavaScript 报错产生的，所以最好是看看控制台打印。</li>
<li>上网搜索资料，发现微信团队做了一个让我兴奋的东西：vConsole<ul>
<li>GitHub 地址：<a href="https://github.com/WechatFE/vConsole" target="_blank" rel="external">https://github.com/WechatFE/vConsole</a></li>
<li>该工具使用很简单，只需要引入一个 JavaScript 文件，即可在页面右下角生成一个按钮，点击可以查看控制台，以及手机系统、手机浏览器的一些信息，真是个神器！</li>
</ul>
</li>
<li><p>引入了 vConsole，查看控制台，果然有一个错误抛出</p>
<blockquote>
<p>reference error can’t find variable symbol</p>
</blockquote>
<p>从字面理解，是指浏览器无法识别 symbol 这个变量。</p>
</li>
<li>继续谷歌，发现 GitHub 上有一些 issue 也是报了类似的问题，一篇一篇地读下来，找到了一个关键词，叫 <code>babel-polyifll</code></li>
<li><p>搜索这个关键词，找到了阮一峰的这篇博文 <a href="http://www.ruanyifeng.com/blog/2016/01/babel.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2016/01/babel.html</a></p>
<blockquote>
<p>Babel默认只转换新的JavaScript句法（syntax），而不转换新的API，比如Iterator、Generator、Set、Maps、Proxy、Reflect、Symbol、Promise等全局对象，以及一些定义在全局对象上的方法（比如<code>Object.assign</code>）都不会转码。<br>举例来说，ES6在<code>Array</code>对象上新增了<code>Array.from</code>方法。Babel就不会转码这个方法。如果想让这个方法运行，必须使用<code>babel-polyfill</code>，为当前环境提供一个垫片。</p>
</blockquote>
</li>
<li><p>这下一切都清楚了，浏览器不支持一些新的对象，所以需要引入别的模块才能识别，具体做法很简单：<br>安装</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm <span class="keyword">install</span> <span class="comment">--save babel-polyfill</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>在脚本中，引入该模块<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">'babel-polyfill'</span>;</div></pre></td></tr></table></figure></p>
<p>编译、测试、问题解决！</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>移动 web 开发的兼容性问题很多，遇到了要多积累经验。</li>
<li>解决问题的思路可以多样化，比如之前一直没想到要在移动端查看控制台，这次解决问题的经历让我学会了一个神器的使用。</li>
<li>谷歌错误信息后，要多打开几个页面，读一读别人的问题以及解决方法，看看能否从中寻找出一些端倪。</li>
<li>学会从一大堆页面和信息中寻找出关键词很重要，一旦找对了，问题很快引刃而解。</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/author.png" alt="Splendour" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Splendour</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">27</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">Kategorien</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">Tags</span>
              
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/splendourhui" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Splendour</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
